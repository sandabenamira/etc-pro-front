{"ast":null,"code":"import axios from \"axios\";\nimport { HIDE_MESSAGE, INIT_URL, ON_HIDE_LOADER, ON_SHOW_LOADER, SHOW_MESSAGE, SIGNIN_FACEBOOK_USER, SIGNIN_FACEBOOK_USER_SUCCESS, SIGNIN_GITHUB_USER, SIGNIN_GITHUB_USER_SUCCESS, SIGNIN_GOOGLE_USER, SIGNIN_GOOGLE_USER_SUCCESS, SIGNIN_TWITTER_USER, SIGNIN_TWITTER_USER_SUCCESS, SIGNIN_USER_SUCCESS, SIGNOUT_USER, SIGNOUT_USER_SUCCESS, SIGNUP_USER, SIGNUP_USER_SUCCESS, GET_USER_PROFILE, THEME_COLOR, FETECHED_ALL_SCHOOL_YEAR_ETAB, SHOW_Licence_MESSAGE, HIDE_Licence_MESSAGE } from \"../constants/ActionTypes\";\nimport cst from \"../config/config\";\nimport { getError } from \"../Error/Error\";\nimport { getThemeColor, getAppLanguage, initCalendar } from \"./Setting\";\nimport _ from 'lodash';\nimport { roleIdAdmin, roleIdSuperAdmin } from \"../config/config\";\nexport const userSignUp = user => {\n  return {\n    type: SIGNUP_USER,\n    payload: user\n  };\n};\nexport const userSignIn = user => {\n  var email = user.email.toLowerCase().trim();\n  var password = user.password;\n  const User = {\n    email,\n    password\n  };\n  return dispatch => {\n    axios.post(`${cst.baseUrl}/users/login`, User).then(res => {\n      // let id = res.data.id;\n      localStorage.setItem(\"token\", res.data.id);\n      localStorage.setItem(\"user_id\", res.data.userId);\n      dispatch(getProfile(res.data.userId));\n    }).catch(err => dispatch(showAuthMessage(\"Veuillez vérifier votre login et mot de passe\")));\n  };\n};\nexport const getProfile = userId => {\n  let user = {};\n  return function (dispatch) {\n    var token = localStorage.getItem(\"token\");\n    axios.get(`${cst.baseUrl}/profiles/getprofile/${userId}?access_token=${token}`).then(res => {\n      let result = res.data.profile[0];\n      user = result.user;\n      dispatch(getThemeColor(result.setting.theme_color));\n      dispatch(getAppLanguage(result.setting.app_lang));\n      dispatch(initCalendar(result.setting.start_time_calendar, result.setting.end_time_calendar));\n      localStorage.setItem(\"profileId\", result.id);\n      localStorage.setItem(\"roles_id\", result.role_id);\n      localStorage.setItem(\"appLang\", result.app_lang);\n      localStorage.setItem(\"first_connexion\", JSON.stringify(result.user.first_connexion));\n      localStorage.setItem(\"user\", JSON.stringify(result.user));\n      dispatch(userSignInSuccess(result.user));\n\n      if (result.establishments.length > 1) {\n        dispatch({\n          type: \"SOW_MODAL_SELECT_ESTABLISHMENT\",\n          payload: result\n        });\n      } else {\n        if (_.isEmpty(result.establishments[0].establishment.licence)) {\n          dispatch(userSignOut());\n\n          if (result.role_id === roleIdAdmin) {\n            dispatch(showLicenceMessage('Votre licence a expiré, Merci de contacter le super admin Educap'));\n          } else if (result.role_id === roleIdSuperAdmin) {\n            dispatch(showLicenceMessage('Votre licence a expiré'));\n          } else {\n            dispatch(showLicenceMessage('Vous avez un problème de paiement, merci de contacter l\\'administrateur de votre école'));\n          }\n        } else {\n          const userProfile = Object.assign({}, result, {\n            establishment_id: result.establishments[0].establishment_id\n          });\n          dispatch({\n            type: GET_USER_PROFILE,\n            payload: userProfile\n          });\n          localStorage.setItem(\"establishment_id\", result.establishments[0].establishment_id);\n          localStorage.setItem(\"school_year_id\", result.establishments[0].establishment.fk_id_school_year_current);\n          dispatch(getEstablishmentsModules(result.establishments[0].establishment.licence[0].licenceModule));\n        }\n      }\n\n      dispatch(getSchoolYear());\n    }).catch(err => {});\n  };\n};\nexport const getSchoolYear = () => {\n  return dispatch => {\n    axios.get(`${cst.baseUrl}/school_years/?access_token=${localStorage.token}`).then(res => {\n      if (res) {\n        dispatch({\n          type: FETECHED_ALL_SCHOOL_YEAR_ETAB,\n          payload: res.data\n        });\n      }\n    }).catch(err => {});\n  };\n};\nexport const getEstablishmentsModules = modules => {\n  return {\n    type: \"GET_ESTABLISHMENT_MODULE\",\n    payload: modules\n  };\n};\nexport const resetAccountPassword = data => {\n  return function (dispatch) {\n    var token = localStorage.getItem(\"token\");\n    axios.post(`${cst.baseUrl}/users/reset-initial-password?access_token=${token}`, data, {\n      headers: {\n        \"content-type\": \"application/json\"\n      }\n    }).then(res => {}).catch(error => {});\n  };\n};\nexport function getUserProfile(userId) {\n  return function (dispatch) {\n    axios.get(`${cst.baseUrl}/profiles/getprofile/${userId}?access_token=${localStorage.token}`).then(res => {\n      const result = res.data.profile[0];\n      let userProfileEstab = { ...result,\n        'establishment_id': localStorage.establishment_id,\n        'school_year_id': result.establishments[0].establishment.fk_id_school_year_current,\n        'current_school_year_id': result.establishments[0].establishment.fk_id_school_year_current,\n        'school_year_name': result.establishments[0].establishment.licence[0].schoolYear.name\n      };\n      dispatch({\n        type: GET_USER_PROFILE,\n        payload: userProfileEstab\n      }); /////\n\n      axios.get(`${cst.baseUrl}/settings/${res.data.profile[0].setting_id}?access_token=${localStorage.token}`).then(res => {\n        dispatch(getThemeColor(res.data.theme_color));\n        dispatch(getAppLanguage(res.data.app_lang));\n        dispatch(initCalendar(res.data.start_time_calendar, res.data.end_time_calendar));\n      }); /////////////\n    }).catch(err => {});\n  };\n}\n\nfunction getprofile(userId, dispatch) {\n  axios.get(`${cst.baseUrl}/profiles/findOne?access_token=${localStorage.token}&filter={\"where\":{\"user_id\":` + userId + `}}`).then(res => {\n    const profiles = res.data;\n    localStorage.setItem(\"profileId\", profiles.id);\n    localStorage.setItem(\"roles_id\", profiles.role_id);\n    localStorage.setItem(\"establishment_id\", profiles.establishment_id);\n  }).catch(err => {\n    if (err.response.status === 401) {\n      dispatch(userSignOut());\n    }\n  });\n}\n\nexport const userSignOut = () => {\n  axios.post(`${cst.baseUrl}/users/logout?access_token=${localStorage.token}`);\n  localStorage.removeItem(\"token\");\n  localStorage.removeItem(\"profileId\");\n  localStorage.removeItem(\"roles_id\");\n  localStorage.removeItem(\"user_id\");\n  localStorage.removeItem(\"establishment_id\");\n  return {\n    type: SIGNOUT_USER\n  };\n};\nexport const userSignUpSuccess = authUser => {\n  return {\n    type: SIGNUP_USER_SUCCESS,\n    payload: authUser\n  };\n};\nexport const userSignInSuccess = authUser => {\n  return {\n    type: SIGNIN_USER_SUCCESS,\n    payload: authUser\n  };\n};\nexport const userSignOutSuccess = () => {\n  return {\n    type: SIGNOUT_USER_SUCCESS\n  };\n};\nexport const showAuthMessage = message => {\n  return {\n    type: SHOW_MESSAGE,\n    payload: message\n  };\n};\nexport const showLicenceMessage = message => {\n  return {\n    type: SHOW_Licence_MESSAGE,\n    payload: message\n  };\n};\nexport const hideLicenceMessage = message => {\n  return {\n    type: HIDE_Licence_MESSAGE\n  };\n};\nexport const userGoogleSignIn = () => {\n  return {\n    type: SIGNIN_GOOGLE_USER\n  };\n};\nexport const userGoogleSignInSuccess = authUser => {\n  return {\n    type: SIGNIN_GOOGLE_USER_SUCCESS,\n    payload: authUser\n  };\n};\nexport const userFacebookSignIn = () => {\n  return {\n    type: SIGNIN_FACEBOOK_USER\n  };\n};\nexport const userFacebookSignInSuccess = authUser => {\n  return {\n    type: SIGNIN_FACEBOOK_USER_SUCCESS,\n    payload: authUser\n  };\n};\nexport const setInitUrl = url => {\n  return {\n    type: INIT_URL,\n    payload: url\n  };\n};\nexport const userTwitterSignIn = () => {\n  return {\n    type: SIGNIN_TWITTER_USER\n  };\n};\nexport const userTwitterSignInSuccess = authUser => {\n  return {\n    type: SIGNIN_TWITTER_USER_SUCCESS,\n    payload: authUser\n  };\n};\nexport const userGithubSignIn = () => {\n  return {\n    type: SIGNIN_GITHUB_USER\n  };\n};\nexport const userGithubSignInSuccess = authUser => {\n  return {\n    type: SIGNIN_GITHUB_USER_SUCCESS,\n    payload: authUser\n  };\n};\nexport const showAuthLoader = () => {\n  return {\n    type: ON_SHOW_LOADER\n  };\n};\nexport const hideMessage = () => {\n  return {\n    type: HIDE_MESSAGE\n  };\n};\nexport const hideAuthLoader = () => {\n  return {\n    type: ON_HIDE_LOADER\n  };\n};\nexport const hideModalSelectEstablishment = () => {\n  return {\n    type: \"HIDE_MODAL_SELECT_ESTABLISHMENT\"\n  };\n};","map":{"version":3,"sources":["/home/oem/Documents/projects/educap/classebook-front-web/src/actions/Auth.js"],"names":["axios","HIDE_MESSAGE","INIT_URL","ON_HIDE_LOADER","ON_SHOW_LOADER","SHOW_MESSAGE","SIGNIN_FACEBOOK_USER","SIGNIN_FACEBOOK_USER_SUCCESS","SIGNIN_GITHUB_USER","SIGNIN_GITHUB_USER_SUCCESS","SIGNIN_GOOGLE_USER","SIGNIN_GOOGLE_USER_SUCCESS","SIGNIN_TWITTER_USER","SIGNIN_TWITTER_USER_SUCCESS","SIGNIN_USER_SUCCESS","SIGNOUT_USER","SIGNOUT_USER_SUCCESS","SIGNUP_USER","SIGNUP_USER_SUCCESS","GET_USER_PROFILE","THEME_COLOR","FETECHED_ALL_SCHOOL_YEAR_ETAB","SHOW_Licence_MESSAGE","HIDE_Licence_MESSAGE","cst","getError","getThemeColor","getAppLanguage","initCalendar","_","roleIdAdmin","roleIdSuperAdmin","userSignUp","user","type","payload","userSignIn","email","toLowerCase","trim","password","User","dispatch","post","baseUrl","then","res","localStorage","setItem","data","id","userId","getProfile","catch","err","showAuthMessage","token","getItem","get","result","profile","setting","theme_color","app_lang","start_time_calendar","end_time_calendar","role_id","JSON","stringify","first_connexion","userSignInSuccess","establishments","length","isEmpty","establishment","licence","userSignOut","showLicenceMessage","userProfile","Object","assign","establishment_id","fk_id_school_year_current","getEstablishmentsModules","licenceModule","getSchoolYear","modules","resetAccountPassword","headers","error","getUserProfile","userProfileEstab","schoolYear","name","setting_id","getprofile","profiles","response","status","removeItem","userSignUpSuccess","authUser","userSignOutSuccess","message","hideLicenceMessage","userGoogleSignIn","userGoogleSignInSuccess","userFacebookSignIn","userFacebookSignInSuccess","setInitUrl","url","userTwitterSignIn","userTwitterSignInSuccess","userGithubSignIn","userGithubSignInSuccess","showAuthLoader","hideMessage","hideAuthLoader","hideModalSelectEstablishment"],"mappings":"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","sourcesContent":["import axios from \"axios\";\r\nimport {\r\n  HIDE_MESSAGE,\r\n  INIT_URL,\r\n  ON_HIDE_LOADER,\r\n  ON_SHOW_LOADER,\r\n  SHOW_MESSAGE,\r\n  SIGNIN_FACEBOOK_USER,\r\n  SIGNIN_FACEBOOK_USER_SUCCESS,\r\n  SIGNIN_GITHUB_USER,\r\n  SIGNIN_GITHUB_USER_SUCCESS,\r\n  SIGNIN_GOOGLE_USER,\r\n  SIGNIN_GOOGLE_USER_SUCCESS,\r\n  SIGNIN_TWITTER_USER,\r\n  SIGNIN_TWITTER_USER_SUCCESS,\r\n  SIGNIN_USER_SUCCESS,\r\n  SIGNOUT_USER,\r\n  SIGNOUT_USER_SUCCESS,\r\n  SIGNUP_USER,\r\n  SIGNUP_USER_SUCCESS,\r\n  GET_USER_PROFILE,\r\n  THEME_COLOR,\r\n  FETECHED_ALL_SCHOOL_YEAR_ETAB,\r\n  SHOW_Licence_MESSAGE,\r\n  HIDE_Licence_MESSAGE\r\n} from \"../constants/ActionTypes\";\r\nimport cst from \"../config/config\";\r\nimport {\r\n  getError\r\n} from \"../Error/Error\";\r\nimport {\r\n  getThemeColor,\r\n  getAppLanguage,\r\n  initCalendar\r\n} from \"./Setting\";\r\nimport _ from 'lodash';\r\nimport { roleIdAdmin, roleIdSuperAdmin } from \"../config/config\";\r\nexport const userSignUp = (user) => {\r\n  return {\r\n    type: SIGNUP_USER,\r\n    payload: user,\r\n  };\r\n};\r\n\r\nexport const userSignIn = (user) => {\r\n  var email = user.email.toLowerCase().trim();\r\n  var password = user.password;\r\n  const User = {\r\n    email,\r\n    password\r\n  };\r\n  return (dispatch) => {\r\n    axios\r\n      .post(`${cst.baseUrl}/users/login`, User)\r\n      .then((res) => {\r\n        // let id = res.data.id;\r\n        localStorage.setItem(\"token\", res.data.id);\r\n        localStorage.setItem(\"user_id\", res.data.userId);\r\n        dispatch(getProfile(res.data.userId))\r\n\r\n      })\r\n      .catch((err) =>\r\n        dispatch(\r\n          showAuthMessage(\"Veuillez vérifier votre login et mot de passe\")\r\n        )\r\n      );\r\n  };\r\n};\r\n\r\nexport const getProfile = (userId) => {\r\n  let user = {};\r\n\r\n  return function (dispatch) {\r\n    var token = localStorage.getItem(\"token\");\r\n    axios\r\n      .get(\r\n        `${cst.baseUrl}/profiles/getprofile/${userId}?access_token=${token}`\r\n      )\r\n      .then((res) => {\r\n        let result = res.data.profile[0];\r\n        user = result.user;\r\n        dispatch(getThemeColor(result.setting.theme_color));\r\n        dispatch(getAppLanguage(result.setting.app_lang));\r\n        dispatch(initCalendar(result.setting.start_time_calendar,result.setting.end_time_calendar));\r\n        localStorage.setItem(\"profileId\", result.id);\r\n        localStorage.setItem(\"roles_id\", result.role_id);\r\n        localStorage.setItem(\"appLang\", result.app_lang);\r\n        localStorage.setItem(\r\n          \"first_connexion\",\r\n          JSON.stringify(result.user.first_connexion)\r\n        );\r\n        localStorage.setItem(\"user\", JSON.stringify(result.user));\r\n        dispatch(userSignInSuccess(result.user));\r\n        if (result.establishments.length > 1) {\r\n          dispatch({\r\n            type: \"SOW_MODAL_SELECT_ESTABLISHMENT\",\r\n            payload: result,\r\n          });\r\n        } else {\r\n       \r\n          if (_.isEmpty(result.establishments[0].establishment.licence)) {\r\n            dispatch(userSignOut())\r\n            if (result.role_id === roleIdAdmin) {\r\n              dispatch(showLicenceMessage('Votre licence a expiré, Merci de contacter le super admin Educap'))\r\n            \r\n            }else if(result.role_id === roleIdSuperAdmin){\r\n              dispatch(showLicenceMessage('Votre licence a expiré'))\r\n            }\r\n             else {\r\n              dispatch(showLicenceMessage('Vous avez un problème de paiement, merci de contacter l\\'administrateur de votre école'))\r\n            }\r\n            \r\n          } else {\r\n            const userProfile = Object.assign({}, result, {\r\n              establishment_id: result.establishments[0].establishment_id,\r\n            });\r\n             dispatch({\r\n              type: GET_USER_PROFILE,\r\n              payload: userProfile\r\n            });\r\n            localStorage.setItem(\"establishment_id\",result.establishments[0].establishment_id);\r\n            localStorage.setItem(\"school_year_id\",result.establishments[0].establishment.fk_id_school_year_current);\r\n            dispatch(getEstablishmentsModules(result.establishments[0].establishment.licence[0].licenceModule));\r\n          }\r\n\r\n        }\r\n\r\n        dispatch(getSchoolYear());\r\n      })\r\n      .catch((err) => {\r\n      });\r\n  };\r\n};\r\n\r\nexport const getSchoolYear = () => {\r\n  return (dispatch) => {\r\n    axios.get(`${cst.baseUrl}/school_years/?access_token=${localStorage.token}`)\r\n      .then((res) => {\r\n        if (res) {\r\n          dispatch({\r\n            type: FETECHED_ALL_SCHOOL_YEAR_ETAB,\r\n            payload: res.data,\r\n          });\r\n        }\r\n      })\r\n      .catch((err) => { });\r\n  };\r\n};\r\n\r\n\r\nexport const getEstablishmentsModules = (modules) => {\r\n  return {\r\n    type: \"GET_ESTABLISHMENT_MODULE\",\r\n    payload: modules\r\n  }\r\n};\r\n\r\nexport const resetAccountPassword = (data) => {\r\n  return function (dispatch) {\r\n    var token = localStorage.getItem(\"token\");\r\n    axios\r\n      .post(\r\n        `${cst.baseUrl}/users/reset-initial-password?access_token=${token}`,\r\n        data, {\r\n        headers: {\r\n          \"content-type\": \"application/json\",\r\n        },\r\n      }\r\n      )\r\n      .then((res) => { })\r\n      .catch((error) => {\r\n      });\r\n  };\r\n};\r\n\r\nexport function getUserProfile(userId) {\r\n  return function (dispatch) {\r\n    axios\r\n      .get(\r\n        `${cst.baseUrl}/profiles/getprofile/${userId}?access_token=${localStorage.token}`\r\n\r\n      )\r\n      .then((res) => {\r\n        const result= res.data.profile[0];\r\n        let userProfileEstab = {\r\n          ...result,\r\n          'establishment_id': localStorage.establishment_id,\r\n          'school_year_id': result.establishments[0].establishment.fk_id_school_year_current,\r\n          'current_school_year_id':result.establishments[0].establishment.fk_id_school_year_current,\r\n          'school_year_name':result.establishments[0].establishment.licence[0].schoolYear.name,\r\n        }\r\n        dispatch({\r\n          type: GET_USER_PROFILE,\r\n          payload: userProfileEstab\r\n        });\r\n        /////\r\n        axios\r\n          .get(\r\n            `${cst.baseUrl}/settings/${res.data.profile[0].setting_id}?access_token=${localStorage.token}`\r\n          )\r\n          .then((res) => {\r\n            dispatch(getThemeColor(res.data.theme_color));\r\n            dispatch(getAppLanguage(res.data.app_lang));\r\n            dispatch(\r\n              initCalendar(\r\n                res.data.start_time_calendar,\r\n                res.data.end_time_calendar\r\n              )\r\n            );\r\n          });\r\n        /////////////\r\n      })\r\n      .catch((err) => {\r\n      });\r\n  };\r\n}\r\n\r\nfunction getprofile(userId, dispatch) {\r\n  axios\r\n    .get(\r\n      `${cst.baseUrl}/profiles/findOne?access_token=${localStorage.token}&filter={\"where\":{\"user_id\":` +\r\n      userId +\r\n      `}}`\r\n    )\r\n    .then((res) => {\r\n      const profiles = res.data;\r\n      localStorage.setItem(\"profileId\", profiles.id);\r\n      localStorage.setItem(\"roles_id\", profiles.role_id);\r\n      localStorage.setItem(\"establishment_id\", profiles.establishment_id);\r\n    })\r\n    .catch((err) => {\r\n      if (err.response.status === 401) {\r\n        dispatch(userSignOut());\r\n      }\r\n    });\r\n}\r\n\r\nexport const userSignOut = () => {\r\n  axios.post(`${cst.baseUrl}/users/logout?access_token=${localStorage.token}`);\r\n  localStorage.removeItem(\"token\");\r\n  localStorage.removeItem(\"profileId\");\r\n  localStorage.removeItem(\"roles_id\");\r\n  localStorage.removeItem(\"user_id\");\r\n  localStorage.removeItem(\"establishment_id\");\r\n\r\n  return {\r\n    type: SIGNOUT_USER,\r\n  };\r\n};\r\n\r\nexport const userSignUpSuccess = (authUser) => {\r\n  return {\r\n    type: SIGNUP_USER_SUCCESS,\r\n    payload: authUser,\r\n  };\r\n};\r\n\r\nexport const userSignInSuccess = (authUser) => {\r\n  return {\r\n    type: SIGNIN_USER_SUCCESS,\r\n    payload: authUser,\r\n  };\r\n};\r\nexport const userSignOutSuccess = () => {\r\n  return {\r\n    type: SIGNOUT_USER_SUCCESS,\r\n  };\r\n};\r\n\r\nexport const showAuthMessage = (message) => {\r\n  return {\r\n    type: SHOW_MESSAGE,\r\n    payload: message,\r\n  };\r\n};\r\n\r\nexport const showLicenceMessage = (message) => {\r\n  return {\r\n    type: SHOW_Licence_MESSAGE,\r\n    payload: message,\r\n  };\r\n};\r\nexport const hideLicenceMessage = (message) => {\r\n  return {\r\n    type: HIDE_Licence_MESSAGE\r\n  };\r\n};\r\nexport const userGoogleSignIn = () => {\r\n  return {\r\n    type: SIGNIN_GOOGLE_USER,\r\n  };\r\n};\r\nexport const userGoogleSignInSuccess = (authUser) => {\r\n  return {\r\n    type: SIGNIN_GOOGLE_USER_SUCCESS,\r\n    payload: authUser,\r\n  };\r\n};\r\nexport const userFacebookSignIn = () => {\r\n  return {\r\n    type: SIGNIN_FACEBOOK_USER,\r\n  };\r\n};\r\nexport const userFacebookSignInSuccess = (authUser) => {\r\n  return {\r\n    type: SIGNIN_FACEBOOK_USER_SUCCESS,\r\n    payload: authUser,\r\n  };\r\n};\r\nexport const setInitUrl = (url) => {\r\n  return {\r\n    type: INIT_URL,\r\n    payload: url,\r\n  };\r\n};\r\nexport const userTwitterSignIn = () => {\r\n  return {\r\n    type: SIGNIN_TWITTER_USER,\r\n  };\r\n};\r\nexport const userTwitterSignInSuccess = (authUser) => {\r\n  return {\r\n    type: SIGNIN_TWITTER_USER_SUCCESS,\r\n    payload: authUser,\r\n  };\r\n};\r\nexport const userGithubSignIn = () => {\r\n  return {\r\n    type: SIGNIN_GITHUB_USER,\r\n  };\r\n};\r\nexport const userGithubSignInSuccess = (authUser) => {\r\n  return {\r\n    type: SIGNIN_GITHUB_USER_SUCCESS,\r\n    payload: authUser,\r\n  };\r\n};\r\nexport const showAuthLoader = () => {\r\n  return {\r\n    type: ON_SHOW_LOADER,\r\n  };\r\n};\r\n\r\nexport const hideMessage = () => {\r\n  return {\r\n    type: HIDE_MESSAGE,\r\n  };\r\n};\r\nexport const hideAuthLoader = () => {\r\n  return {\r\n    type: ON_HIDE_LOADER,\r\n  };\r\n};\r\nexport const hideModalSelectEstablishment = () => {\r\n  return {\r\n    type: \"HIDE_MODAL_SELECT_ESTABLISHMENT\",\r\n  };\r\n};"]},"metadata":{},"sourceType":"module"}